#include "rpi.h"
#include "gpio.h"

#define GPIO_BASE 0x20200000
#define GPSET0  (GPIO_BASE+0x1c)
#define GPCLR0  (GPIO_BASE+0x28)
#define GPLEV0  (GPIO_BASE+0x34)
// GPIO Pin Rising Edge Detect Enable 0/1
#define GPREN0 (GPIO_BASE+0x4C)
#define GPREN1 (GPIO_BASE+0x50)
// GPIO Pin Falling Edge Detect Enable 0/1
#define GPFEN0 (GPIO_BASE+0x58)
#define GPFEN1 (GPIO_BASE+0x5C)
// GPIO Pin Async Rising Edge Detect Enable 0/1
#define GPAREN0 (GPIO_BASE+0x7C)
#define GPAREN1 (GPIO_BASE+0x80)
// GPIO Pin Async Falling Edge Detect Enable 0/1
#define GPAFEN0 (GPIO_BASE+0x88)
#define GPAFEN1 (GPIO_BASE+0x8C)
// GPIO Pin Event Detect Status 0/1
#define GPEDS0 (GPIO_BASE+0x40)
#define GPEDS1 (GPIO_BASE+0x44)

int gpio_set_function(unsigned pin, unsigned val) {
        if(pin >= 32)
                return -1;
	if((val & 0b111) != val)
		return -1;

        unsigned *gp = ((unsigned *)GPIO_BASE + pin/10);
        unsigned off = (pin%10)*3;

        unsigned v = get32(gp);
                v &= ~(0b111 << off);
                v |= (val << off);
        put32(gp, v);
        return 0;
}

int gpio_set_output(unsigned pin) {
	return gpio_set_function(pin, GPIO_FUNC_OUTPUT);
}

int gpio_set_input(unsigned pin) {
	return gpio_set_function(pin, GPIO_FUNC_INPUT);
}

int gpio_set_off(unsigned pin) {
	if(pin >= 32)
		return -1;
	PUT32(GPCLR0, 1 << pin);
	return 0;
}
int gpio_set_on(unsigned pin) {
	if(pin >= 32)
		return -1;
	PUT32(GPSET0, 1 << pin);
	return 0;
}

int gpio_write(unsigned pin, unsigned v) {
	if(v)
		return gpio_set_on(pin);
	else
		return gpio_set_off(pin);
}

// doesn't do error checking...
unsigned gpio_read(unsigned pin) {
	assert(pin < 32);
        unsigned bank  = (GPLEV0 + pin/32);
        unsigned off = (pin%32);
	return (GET32(bank) >> off) & 1;
}
